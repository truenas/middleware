#!/usr/bin/env python

import argparse
import requests
import uuid
import time
import os
import traceback
import hashlib

parser = argparse.ArgumentParser(description='send data to iXsystems')
parser.add_argument('files', metavar='files', type=str, nargs='+', help='files to upload')
parser.add_argument('--jitter', action='store_true',  help='delay running based on hash of UUID.')
parser.add_argument('--debug', action='store_true',  help="Debug/Verbose output")

args = parser.parse_args()

hostid = ''
dmisha256 = ''
sha256 = ''
m = 1
piece_size = 1024*1024  # 1 MiB


if os.path.isfile("/etc/hostid"):
    with open("/etc/hostid", 'r') as f:
        hostid = f.read().strip()
    u = uuid.UUID("{" + hostid + "}")
    m = u.int % 60

if os.path.isfile("/tmp/dmisha.txt"):
    with open("/tmp/dmisha.txt", 'r') as f:
        dmisha256 = f.read().strip()
    f.close()

if args.jitter:
    # print "Sleeping for " + str(m) + " minutes \n"
    time.sleep(60*m)

if 'TELEMETRYSERVER_URL' in os.environ:
    url = os.environ['TELEMETRYSERVER_URL']
else:
    url = 'https://ext-data.ixsystems.com/telemetry/uploader/list/'


for file in args.files:
    try:
        if args.debug:
            print " running sha256 "
        sha256 = hashlib.sha256()
        with open(file, 'r') as f:
            read = f.read(piece_size)
            while read:
                sha256.update(read)
                read = f.read(piece_size)
            sha256 = sha256.hexdigest()
    except:
        sha256 = ''
        if args.debug:
            print traceback.format_exc().splitlines()

    files = {
        'docfile': open(file, 'rb')
    }
    data = {
        'hostid': hostid,
        'dmi-sha256': dmisha256,
        'sha256': sha256
    }
    if args.debug:
        print data
    r = requests.post(url, data=data, files=files)
    if args.debug:
        print r
        status_code = r.status_code
