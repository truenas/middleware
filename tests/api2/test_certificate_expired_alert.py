from middlewared.test.integration.utils import call


def test_expired_certificate():
    id_ = call('datastore.insert', 'system.certificate', {
        'certificate': '-----BEGIN CERTIFICATE-----\nMIIDrTCCApWgAwIBAgIELrqsVTANBgkqhkiG9w0BAQsFADCBgDELMAkGA1UEBhMC\nVVMxEjAQBgNVBAoMCWlYc3lzdGVtczESMBAGA1UEAwwJbG9jYWxob3N0MSEwHwYJ\nKoZIhvcNAQkBFhJpbmZvQGl4c3lzdGVtcy5jb20xEjAQBgNVBAgMCVRlbm5lc3Nl\nZTESMBAGA1UEBwwJTWFyeXZpbGxlMB4XDTI0MDEwMTA4MDAyNVoXDTI1MDIwMTA4\nMDAyNVowgYAxCzAJBgNVBAYTAlVTMRIwEAYDVQQKDAlpWHN5c3RlbXMxEjAQBgNV\nBAMMCWxvY2FsaG9zdDEhMB8GCSqGSIb3DQEJARYSaW5mb0BpeHN5c3RlbXMuY29t\nMRIwEAYDVQQIDAlUZW5uZXNzZWUxEjAQBgNVBAcMCU1hcnl2aWxsZTCCASIwDQYJ\nKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKhwebvJ66PPiGgYHdBHTIT1oDAW0T9x\nZMlURfiI8/ld1W28PsBewwM4u6OvljftAdZXIqAzx9cFy+WOrxN5Fz03cdT9dEXl\nTxAjJkC8lh5dVX0SELhwcQ5RVsGrQVZXxCrYt72uP6sDU24GbFt/nmxGzS9cWIjn\nqq+oVQLHZsrUB8LatUxKntVYzAD5X0xO8Sg9eK1gjrQfQEa/XK1XZ3gK0JdlCAk8\n+N+iQUUEy0YC/d/45Vt+8Tvaqr1mZ2cO4yEa1em2vREsLF2AMSfrLbWAjS5TOIqj\nRA4lMEA8Usxqy9hJ4LfYFq/nQeT3gp37u69Vhw7C6ZfjjmuC/owreZ0CAwEAAaMt\nMCswFAYDVR0RBA0wC4IJbG9jYWxob3N0MBMGA1UdJQQMMAoGCCsGAQUFBwMBMA0G\nCSqGSIb3DQEBCwUAA4IBAQCL3BOvsVfQ2a1uZSYl47+JekMVcXZfVBkJeZP66Hbg\nJ5ALTKn5/2bJd4ZOrvysQsk5UlhHGQU0cxTvEeCMck1K8V5LedIaSCJiO+17GAhe\nR6hDCCv1xcSCJNH8KaGR1Hnwx2Tm7AbStViGyFzlnF5CJUZzaxdjUC9E/okZOR8D\nGupwY+wnX8I+oYltcnPPQWKPfuyX22BnWN3qmlx122B5U4VTJ4d+srEEu7V4/u6W\nilwNqSD/tJdMsJDHxR2K/yAVwbfIxg1wHm45EtnO1ir5dRc7KyXL+h/dlqH/86FS\nQKzb/YHDgAVtDWpbtnXL/u+za5d1BFaLjzbZeor/F/yv\n-----END CERTIFICATE-----\n',
        'privatekey': '-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCocHm7yeujz4ho\nGB3QR0yE9aAwFtE/cWTJVEX4iPP5XdVtvD7AXsMDOLujr5Y37QHWVyKgM8fXBcvl\njq8TeRc9N3HU/XRF5U8QIyZAvJYeXVV9EhC4cHEOUVbBq0FWV8Qq2Le9rj+rA1Nu\nBmxbf55sRs0vXFiI56qvqFUCx2bK1AfC2rVMSp7VWMwA+V9MTvEoPXitYI60H0BG\nv1ytV2d4CtCXZQgJPPjfokFFBMtGAv3f+OVbfvE72qq9ZmdnDuMhGtXptr0RLCxd\ngDEn6y21gI0uUziKo0QOJTBAPFLMasvYSeC32Bav50Hk94Kd+7uvVYcOwumX445r\ngv6MK3mdAgMBAAECggEABl8Sy76skiq0fzOCVTGNPG5KG+eRDLROWqs8ZlVP3Tvm\nads4CHDNMZ8AwgVPSlhFvITZQ3QR+Bk5CDrodnUbIu6o+KSJtGcjIXoi5Un857Mi\nG7QGO+PM8vyyqmq+8vQo8HH4KU2hDOf4TO4jRSbDqFbZRhRZKPySYUidxpgiVEO3\nOWuZ+07nsfDS6Qvz3ntKmilsaTCwZJCdjxEk5qlPlSmuipcf3+eFJ3jgudDOMEMd\nz0aBlG2XtpLGnovgaXvrAGpP5X9wPb0etMQV5UZYHpJLF6hh5E6WqaPo+OCWvd7k\nzhDg+XD1f95gncpDn/Qxlierl1YX9IFWZYSpqF5ABQKBgQDZhPrir+J7duZ9wuve\nRBNeh+76qpZXga891DVQ6qMT1m665ymKlXro1fTeL6jRtSUTVnjImcKci5EpoySp\nCYgaSDfYfmfF+VQMtnlsRAv5KrSISDKwQW6Je4gy7sjWE6qkQUIQA4EVJep+Tz8V\nEAouPJlNT/5dWxK0zDl7CgFo4wKBgQDGPMGgiRuDbG/yJCWS9LLWh4UPwttmrH+x\nhL63NGFGQshqwK+4nxbxQ9BFX8KfTZu23OhtalqFnsjQLBIkQMi46NxZPlo/kY8r\nvxv5UBJIK/RucX01tD6lRqcL5p1ZkDRCwOLx0fwIlDk6iBn5C9hnGZbEBQWt8bXN\n3VhDRd2bfwKBgFqNnLBQTnXdqtjCE9Vk+7dH2boq2Am36E9SD5wPAjLY+yH95/JU\nhmV15Mm2h4493iBtyDyinjzzcUwnKbThTfK7C9ypyuPFBzN/p47lySJCoAN4Ivnz\nU2QStEGX3K4aY9ibfjgSbWNzdGp+7SEEm2hiO+POoHMW3fO8bVWGdc3HAoGBAIFE\nvT7iKX7aB2XvDFF4H+alGK/ecRPTCLHJzlPJZGVcxzRV0kCh/WP2xKl4eIFJKnFk\nPGydHcpkcK7PDkV1uW5a6tWHQ3KQiLwOMz+wZzuI7ivW9b8/elpsaCHqkFEHKA0f\nmt32AFPX1DnG5qjwgH06woWwgLOdGuDTpeq4dHohAoGBALERucOuXi3gxHIyugAN\n4z1RE1StU1ywWE4fMnkSMsNFyuNn1FD57X97xGqE0nU4lBDCf0SQjFkSV9MFK7QI\nR9+QKZENVDLCHKrYhZZJcJ+9u/1SXc6gmDtA1JeJyzXfKddvht1W4dkJHjhs1AF1\nLL/21NPlQfDDNTd3SK/VOqfc\n-----END PRIVATE KEY-----\n',
        'name': 'expired_certificate',
        'type': 8,
    }, {'prefix': 'cert_'})
    try:
        alerts = call('alert.run_source', 'CertificateChecks')
        assert len(alerts) == 1
        assert alerts[0]['klass'] == 'CertificateExpired'
    finally:
        call('datastore.delete', 'system.certificate', id_)
